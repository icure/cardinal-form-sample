{"version":3,"file":"suggestion-palette.js","sourceRoot":"","sources":["../../../tmp/components/icure-text-field/suggestion-palette.ts"],"names":[],"mappings":"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","sourcesContent":["import equal from 'fast-deep-equal'\n\nimport { EditorView } from 'prosemirror-view'\nimport { EditorState, Transaction } from 'prosemirror-state'\nimport { Schema } from 'prosemirror-model'\nimport { Suggestion } from '../../generic'\n\nexport class SuggestionPalette {\n\tprivate readonly palette: HTMLDivElement\n\tprivate delay: () => boolean = () => false\n\tprivate lastTime = 0\n\tprivate suggestionProvider: (terms: string[]) => Promise<Suggestion[]>\n\tprivate previousFingerprint?: string\n\n\tprivate suggestionStopWordsProvider: () => Set<string>\n\tprivate currentFocus?: number\n\tprivate hasFocus = false\n\tprivate suggestions: Suggestion[] = []\n\tprivate schema: Schema\n\n\tconstructor(\n\t\tschema: Schema,\n\t\tview: EditorView,\n\t\tsuggestionProvider: (terms: string[]) => Promise<Suggestion[]>,\n\t\tsuggestionStopWordsProvider: () => Set<string>,\n\t\tdelay?: () => boolean,\n\t) {\n\t\tthis.schema = schema\n\t\tthis.suggestionStopWordsProvider = suggestionStopWordsProvider\n\t\tthis.suggestionProvider = suggestionProvider\n\t\tthis.palette = document.createElement('div')\n\t\tthis.palette.className = 'suggestion-palette'\n\n\t\tview.dom?.parentNode?.appendChild(this.palette)\n\n\t\tdelay && (this.delay = delay)\n\n\t\tthis.update(view, undefined)\n\t}\n\n\tfocusItem(idx?: number): void {\n\t\tconst ul = this.palette.getElementsByTagName('ul')[0]\n\t\tif (ul) {\n\t\t\tul.classList.add('focused')\n\t\t\tconst lis = ul.getElementsByTagName('li')\n\t\t\tthis.currentFocus !== undefined && (lis[this.currentFocus] as HTMLElement).classList.remove('focused')\n\t\t\tidx !== undefined && (lis[idx] as HTMLElement).classList.add('focused')\n\n\t\t\tthis.currentFocus = idx\n\t\t}\n\t}\n\n\tfocus(): boolean {\n\t\tif (this.palette.style.display === 'none') return false\n\t\tthis.hasFocus = true\n\t\tthis.focusItem(0)\n\t\treturn true\n\t}\n\n\tfocusOrInsert(view: EditorView, transactionProvider: (from: number, to: number, sug: Suggestion) => Promise<Transaction | undefined>): boolean {\n\t\tif (this.palette.style.display === 'none') return false\n\t\treturn this.hasFocus ? this.insert(view, transactionProvider) : this.focus()\n\t}\n\n\tinsert(view: EditorView, transactionProvider: (from: number, to: number, sug: Suggestion) => Promise<Transaction | undefined>): boolean {\n\t\tif (this.palette.style.display === 'none' || !this.hasFocus || this.currentFocus === undefined) return false\n\t\tconst sug = this.suggestions[this.currentFocus]\n\t\tif (sug) {\n\t\t\tconst sel = view.state.selection\n\t\t\tconst stopWords = this.suggestionStopWordsProvider()\n\n\t\t\tlet length = sug.terms.join(' ').length - 1\n\t\t\twhile (\n\t\t\t\tsel.to - length >= 0 &&\n\t\t\t\t!equal(\n\t\t\t\t\tview.state.doc\n\t\t\t\t\t\t.textBetween(sel.to - length, sel.to)\n\t\t\t\t\t\t.split(/\\s+/)\n\t\t\t\t\t\t.filter((x) => !stopWords.has(x)),\n\t\t\t\t\tsug.terms,\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tlength++\n\t\t\t}\n\t\t\tif (length > sel.to) {\n\t\t\t\tlength = sug.terms.join(' ').length\n\t\t\t\twhile (sel.to - length >= 0 && !view.state.doc.textBetween(sel.to - length, sel.to).startsWith(sug.terms[0])) {\n\t\t\t\t\tlength++\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (length <= sel.to) {\n\t\t\t\ttransactionProvider(sel.to - length, sel.to, sug).then((tr) => tr && view.dispatch(tr.scrollIntoView()))\n\t\t\t}\n\t\t\tthis.palette.style.display = 'none'\n\t\t\treturn true\n\t\t}\n\t\treturn false\n\t}\n\n\tarrowUp(): boolean {\n\t\tif (!this.hasFocus) return false\n\t\tthis.currentFocus && this.focusItem(this.currentFocus - 1)\n\t\treturn true\n\t}\n\n\tarrowDown(): boolean {\n\t\tif (!this.hasFocus) return false\n\t\tthis.currentFocus !== undefined && this.currentFocus < this.palette.getElementsByTagName('ul')[0].childElementCount - 1 && this.focusItem(this.currentFocus + 1)\n\t\treturn true\n\t}\n\n\tupdate(view: EditorView, lastState?: EditorState): void {\n\t\tconst state = view.state\n\n\t\t// Hide the palette if the selection is not empty\n\t\tthis.focusItem(undefined)\n\t\tthis.hasFocus = false\n\n\t\tif (!state.selection.empty) {\n\t\t\tthis.palette.style.display = 'none'\n\t\t\treturn\n\t\t}\n\n\t\tconst $pos = state.selection.$head\n\t\tif (lastState?.doc.textContent === state.doc.textContent) {\n\t\t\tthis.palette.style.display = 'none'\n\t\t\treturn\n\t\t}\n\n\t\tconst text = state.doc.textBetween($pos.pos && $pos.depth ? $pos.before() + 1 : 0, $pos.pos)\n\n\t\tconst words = text.split(/\\s+/)\n\t\tconst lastWordDelta = Math.min(\n\t\t\twords\n\t\t\t\t.concat()\n\t\t\t\t.reverse()\n\t\t\t\t.reduce((d, w) => (d < 0 ? d : w.length ? -d - w.length : d + 1), 0),\n\t\t\t-1,\n\t\t)\n\t\tconsole.log('lwd', lastWordDelta)\n\t\tif ($pos.pos > 1 && state.doc.rangeHasMark($pos.pos + lastWordDelta, $pos.pos, this.schema.marks['link'])) {\n\t\t\tconsole.log('Skip suggestion')\n\t\t\tthis.palette.style.display = 'none'\n\t\t\treturn\n\t\t}\n\n\t\tconst terms = words.filter((x) => x.length > 2 && !this.suggestionStopWordsProvider().has(x))\n\t\tconst lastTerms = terms.length > 3 ? terms.slice(length - 3) : terms\n\t\tconst fingerprint = lastTerms.join(' ')\n\n\t\tconst { to } = state.selection\n\n\t\tif (this.previousFingerprint !== fingerprint) {\n\t\t\tthis.previousFingerprint = fingerprint\n\t\t\tsetTimeout(async () => {\n\t\t\t\tif (this.previousFingerprint !== fingerprint) return\n\t\t\t\tconst res = await this.suggestionProvider(lastTerms)\n\t\t\t\tthis.suggestions = res\n\t\t\t\tif (res.length) {\n\t\t\t\t\tthis.palette.innerHTML = `<ul>${res\n\t\t\t\t\t\t.map(\n\t\t\t\t\t\t\t(x) =>\n\t\t\t\t\t\t\t\t`<li id=\"${x.id}\" data-code=\"${x.code}\">${x.text}<div class=\"icn-container\"><svg class=\"tab-icn\" viewBox=\"0 0 24 24\"><path d=\"M12.29 8.12L15.17 11H2c-.55 0-1 .45-1 1s.45 1 1 1h13.17l-2.88 2.88c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l4.59-4.59c.39-.39.39-1.02 0-1.41L13.7 6.7c-.39-.39-1.02-.39-1.41 0-.38.39-.39 1.03 0 1.42zM20 7v10c0 .55.45 1 1 1s1-.45 1-1V7c0-.55-.45-1-1-1s-1 .45-1 1z\"/></svg><svg class=\"return-icn\" viewBox=\"0 0 24 24\"><path d=\"M19 8v3H5.83l2.88-2.88c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0L2.71 11.3c-.39.39-.39 1.02 0 1.41L7.3 17.3c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.83 13H20c.55 0 1-.45 1-1V8c0-.55-.45-1-1-1s-1 .45-1 1z\"/></svg></div></li>`,\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.join('\\n')}</ul>`\n\t\t\t\t\t// These are in screen coordinates\n\t\t\t\t\tconst end = view.coordsAtPos(to)\n\t\t\t\t\tconst start = view.coordsAtPos(Math.max(0, to - terms[terms.length - 1].length))\n\n\t\t\t\t\tthis.display(start.left > end.left ? end : start, (this.lastTime = +new Date()))\n\t\t\t\t} else {\n\t\t\t\t\tthis.palette.style.display = 'none'\n\t\t\t\t}\n\t\t\t}, 30)\n\t\t}\n\t}\n\n\tprivate display(pos: { left: number; right: number; top: number; bottom: number }, time: number): void {\n\t\tif (time !== this.lastTime) return\n\t\tif (this.delay()) {\n\t\t\tsetTimeout(() => this.display(pos, time), 100)\n\t\t\treturn\n\t\t}\n\t\tthis.palette.style.display = ''\n\t\tconst box = this.palette.offsetParent?.getBoundingClientRect()\n\t\tconst palBox = this.palette.getBoundingClientRect()\n\t\tif (box) {\n\t\t\tthis.palette.style.left = Math.max(0, Math.min(pos.left - box.left - 12, box.width - palBox.width)) + 'px'\n\t\t\tthis.palette.style.top = pos.bottom - box.top + 4 + 'px'\n\t\t}\n\t}\n\n\tdestroy(): void {\n\t\tthis.palette.remove()\n\t}\n}\n"]}